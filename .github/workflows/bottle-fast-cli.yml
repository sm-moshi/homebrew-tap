name: bottle fast-cli
permissions:
  contents: write
on:
  workflow_dispatch:
  push:
    paths:
    - Formula/fast-cli.rb

jobs:
  bottle-intel:
    runs-on: macos-13 # Intel
    steps:
    - uses: actions/checkout@v6
    - uses: Homebrew/actions/setup-homebrew@main
    - name: Build bottle
      env:
        HOMEBREW_NO_ANALYTICS: 1
        HOMEBREW_NO_AUTO_UPDATE: 1
      run: |
        set -euo pipefail
        brew update
        VERSION=$(ruby -e 'puts File.read("Formula/fast-cli.rb")[/version\s+"([^"]+)",1]')
        echo "VERSION=$VERSION" >> "$GITHUB_ENV"
        brew install --build-bottle ./Formula/fast-cli.rb
        brew bottle --json --root-url "https://github.com/${{ github.repository }}/releases/download/fast-cli-${VERSION}" fast-cli
    - name: Upload bottle artifact
      uses: actions/upload-artifact@v5
      with:
        name: bottle-intel
        path: |
          *.json
          *.tar.gz

  bottle-arm:
    runs-on: macos-14 # Apple Silicon
    steps:
    - uses: actions/checkout@v6
    - uses: Homebrew/actions/setup-homebrew@main
    - name: Build bottle
      env:
        HOMEBREW_NO_ANALYTICS: 1
        HOMEBREW_NO_AUTO_UPDATE: 1
      run: |
        set -euo pipefail
        brew update
        VERSION=$(ruby -e 'puts File.read("Formula/fast-cli.rb")[/version\s+"([^"]+)",1]')
        echo "VERSION=$VERSION" >> "$GITHUB_ENV"
        brew install --build-bottle ./Formula/fast-cli.rb
        brew bottle --json --root-url "https://github.com/${{ github.repository }}/releases/download/fast-cli-${VERSION}" fast-cli
    - name: Upload bottle artifact
      uses: actions/upload-artifact@v5
      with:
        name: bottle-arm
        path: |
          *.json
          *.tar.gz

  release-and-merge:
    needs: [ bottle-intel, bottle-arm ]
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v6
    - uses: actions/download-artifact@v7
      with:
        name: bottle-intel
        path: bottles
    - uses: actions/download-artifact@v7
      with:
        name: bottle-arm
        path: bottles
    - name: Determine version
      run: |
        VERSION=$(ruby -e 'puts File.read("Formula/fast-cli.rb")[/version\s+"([^"]+)",1]')
        echo "VERSION=$VERSION" >> "$GITHUB_ENV"
    - uses: Homebrew/actions/setup-homebrew@main
    - name: Create/Update GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: fast-cli-${{ env.VERSION }}
        files: bottles/*
    - name: Merge bottle block into formula
      run: |
        brew update
        # Collect JSON files safely without word splitting or globbing
        mapfile -d '' files < <(find bottles -maxdepth 1 -name '*.json' -print0)
        # Merge bottle block
        brew bottle --merge --write --no-commit "${files[@]}"
        # Commit
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Formula/fast-cli.rb
        git commit -m "fast-cli: add bottle block for ${VERSION}"
        git push
